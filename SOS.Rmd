---
title: "SOS"
author: "ST"
date: "2023-11-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Step 1. Install / load packages
```{r}
# Install and load required packages
#install.packages("purrr")
library(purrr)
```

Step 2. Read each .txt file into R as a data frame 
Ensure .Rmd file and all timepoint.txt files are in the same working directory
```{r}

# List all timepoint.txt files in the directory
txt_files <- list.files(pattern = ".txt", full.names = FALSE)

# Empty list of data frame names
list_df_names <- list()

# Function to read a .txt file and return as a data frame
read_and_number_df <- function(file_path) {
  # Read the file into a data frame
  df <- read.table(file_path, sep = ",", header = FALSE, col.names = c("x_pixel", "y_pixel", "Frame_number", "Molecule_ID"))

  # Extract the file name
  file_name <- sub(pattern = ".txt", "", basename(file_path))
  
  # Assign file name to the data frame
  assign(paste0(file_name), df, envir = .GlobalEnv)
  
  # Append data frame name to list_df_names
  list_df_names <<- append(list_df_names, toString(file_name))
}

# Use purrr::walk to apply the function to each file in the txt_files list
walk(txt_files, read_and_number_df)


```

Step 3. Calculate x and y physical lengths for each molecule 

```{r}
# Function to calculate x and y physical length from pixels for each molecule 
calc_phys_length <- function(df_name) {
  # Retrieve the data frame
  df <- get(df_name)
  
  # Calculate physical lengths and create a new column "x_pos" and "y_pos"
  df$x_pos <- df$x_pixel * 0.107
  df$y_pos <- df$y_pixel * 0.107
  
  # Assign the modified data frame back
  assign(df_name, df, envir = .GlobalEnv)
}

# Use purrr::walk to apply the function to each file in the data frame list
walk(list_df_names, calc_phys_length)



```

Step 4. Filter cases where Molecule_ID frequency is <= 4 

```{r}

#Function to filter the frequencies of Molecule_ID with 4 or less records.
filter_data <- function(timepoints) {
  # Retrieve data frame
  df <- get(timepoints)

  # Convert the Molecule ID column to factor (categorical variable)
  df$Molecule_ID <- as.factor(df$Molecule_ID)

  # Filter to only include molecule IDs with 5 or more records.
  df <- df %>%
    group_by(Molecule_ID) %>%
    filter(n() >= 5)

  # Return modified data frame back
  assign(timepoints, df, envir = .GlobalEnv)
}


walk(list_df_names, filter_data)

```

Step 6. Calculate mean squared difference (MSD) and diffusion coefficient (D)
```{r}
# Function to Calculate mean squared difference (MSD) and diffusion coefficient (D)
calc_MSD_D <- function(timepoints){
  # Retrieve the data frame
  df <- get(timepoints)
  
  # Create new dataframe
  df_new_name <- paste0(timepoints, "_calculations")
  df_new <- setNames(data.frame(matrix(ncol = 3, nrow = 0)), c("Track_ID", "MSD", "D"))

  # List of unique molecule IDs in data frame
  molecule_ID <- unique(df$Molecule_ID)

  # Loop through list of all unique molecule IDs and calculate MSD and D
  for (x in 1:length(molecule_ID)){
    # Create subset of all tracks for a molecule ID
    Track_ID = molecule_ID[x]
    dummy_df <- subset(df, Molecule_ID == Track_ID)
  
    # Calculate MSD in μm^2
    # MSD = 1/(N-1) ∑(x_{i+1} – x_i)**2 + (y_{i+1} – yi)**2
  
    N = 5     # Number of tracks
    MSD = 0   # Reset MSD
    sum_SD = 0  #Reset sum_SD
  
    # index no. 5 = x_pos;  index no. 6 = y_pos
    # Loop through dummy_df and calculate the sum of squared difference
    for (i in 1:(N-1)){
      sum_SD <- sum_SD + (dummy_df[i+1,5] - dummy_df[i,5])**2 + 
        (dummy_df[i+1,6] - dummy_df[i,6])**2
    }

  # Mean squared difference = sum_SD / N-1
  MSD <- sum_SD/(N-1)
  
  # Calculate D in μm^2/s
  dT = 0.00748
  D <- MSD /((N-1)*dT)
  
  # Add a new row to the new data frame for MSD and D
  df_new[nrow(df_new) + 1,] = c(Track_ID, MSD, D)
  }
  
  # Return new data frame back to global environment
  assign(df_new_name, df_new, envir = .GlobalEnv)
  
  #Print progress 
  cat("Finished for", timepoints, "\n")
}

# Use purrr::walk to apply the function to each file in the data frame list
walk(list_df_names, calc_MSD_D)
```
